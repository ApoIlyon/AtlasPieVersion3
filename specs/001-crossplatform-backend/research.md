# Research: Cross-Platform Backend Architecture

## Decision 1: Архитектура backend трейта и диспетчера
- **Decision**: Ввести модуль `backend` с треитом `Backend` и диспетчером, выбирающим реализацию по `std::env::consts::OS` и дополнительным переменным окружения (для Wayland/X11).
- **Rationale**: Позволяет централизовать платформенно-зависимую логику и подменять реализации без изменения фронтенда; повторяет подход Kando.
- **Alternatives considered**:
  - Загружать плагины динамически — избыточно для MVP, усложняет поставку.
  - Использовать `cfg!` в каждом месте вызова — ведёт к дублированию и сложной поддержке.

## Decision 2: Подключение CLI `--toggle`
- **Decision**: использовать `tauri::async_runtime::spawn` для отправки IPC-команды активному экземпляру через `tauri::AppHandle::emit`/custom channel; CLI обрабатывает отсутствие экземпляра и возвращает ошибку.
- **Rationale**: Соответствует требованию автономно вызывать toggle снаружи; интегрируется с существующим Tauri CLI плагином.
- **Alternatives considered**:
  - Встроенный процесс/демон без IPC — не решает задачу множественных вызовов из DE.
  - Использовать файловый сокет/Unix socket — требует дополнительной инфраструктуры и разрешений.

## Decision 3: Получение позиции курсора
- **Decision**: Windows backend использует текущие Win32 вызовы через tauri-plugin (существующая логика). Для Wayland/X11 создать функцию-заглушку, возвращающую `None`; fallback — центр активного экрана через Tauri window API.
- **Rationale**: Позволяет быстро дать MVP без глубоких Wayland интеграций; поведение соответствует спецификации.
- **Alternatives considered**:
  - Немедленно реализовать Wayland protocol (zwlr_cursor_position_v1) — требует значительного времени и протокол-специфических библиотек.
  - Запрашивать позицию через фронтенд — ненадёжно при скрытом окне, зависит от фокуса.

## Decision 4: Управление прозрачным окном overlay
- **Decision**: Создать второе окно `pie-overlay` в `tauri.conf.json` и управлять им через сервис `pie_overlay.rs`, предоставляющий методы `show_at(x, y)` и `hide()` для backend.
- **Rationale**: Соответствует требованию и позволяет централизовать операции над окном.
- **Alternatives considered**:
  - Создавать окно динамически при каждом показе — медленно и вызывает артефакты.
  - Использовать одно окно с изменением стиля — сложнее для IPC и управления слоями.

## Decision 5: Документация Wayland setup
- **Decision**: Подготовить quickstart с инструкциями для GNOME, KDE, Hyprland/Niri, подчёркивая использование системных хоткеев и демон-режима.
- **Rationale**: Требуется спецификацией; обеспечивает пользователей знаниями по настройке.
- **Alternatives considered**:
  - Отложить документацию до полной реализации Wayland backend — оставляет пользователей без понятного способа запуска.

## Outstanding Clarification
- **NEEDS CLARIFICATION**: Требуется определить и зафиксировать реальные принципы в `.specify/memory/constitution.md`; текущий документ пуст.
