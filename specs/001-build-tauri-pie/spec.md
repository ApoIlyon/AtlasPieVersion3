# Feature Specification: AutoHotPie Tauri Native Suite

**Feature Branch**: `[001-build-tauri-pie]`  
**Created**: 2025-10-17  
**Status**: Draft  
**Input**: User description: "Создать Tauri-приложение autohotpie-tauri как локальный аналог pie-меню из AutoHotPie: интерфейс и UX взять из проекта kando-2.0.0 , функциональность редактора профилей и меню — из AutoHotPiehttps-main , но реализовать всё нативно без AutoHotkey. Нужно обеспечить управление профилями, настройку pie-меню, глобальные хоткеи, запуск действий (приложения, клавиатурные макросы), импорт/экспорт настроек JSON и автозапуск. UI — тёмная тема и компоненты, вдохновлённые kando; backend — команды Tauri на Rust, хранение пользовательских данных в %APPDATA%/AutoHotPie. Поддержать локализацию, менеджер иконок и предпросмотр меню."

## Clarifications

### Session 2025-10-17

- Q: Как обеспечиваем безопасность при запуске новых или изменённых действий? → A: Автозапуск всех действий без дополнительных проверок.
- Q: Нужна ли удалённая телеметрия и как представить логи? → A: Только локальные журналы; добавить кнопку "Log", открывающую файл логов.
- Q: Как реализуем обновления приложения? → A: Проверка GitHub-релизов как в `kando-2.0.0`, уведомление и ручная установка.
- Q: Должно ли меню активироваться только в выбранных приложениях? → A: Да, профили можно привязывать к процессам/названиям окон, и pie-меню работает только при совпадении условий.

### Session 2025-10-20

- Q: Сколько поколений резервных копий пользовательских данных хранить автоматически? → A: Хранить последние 5 резервных копий на профиль/набор настроек.
- Q: Как часто приложение должно автоматически проверять GitHub-релизы? → A: Выполнять проверку раз в 6 часов во время работы приложения.

## User Scenarios & Testing *(mandatory)*

<!--
  IMPORTANT: User stories should be PRIORITIZED as user journeys ordered by importance.
  Each user story/journey must be INDEPENDENTLY TESTABLE - meaning if you implement just ONE of them,
  you should still have a viable MVP (Minimum Viable Product) that delivers value.
  
  Assign priorities (P1, P2, P3, etc.) to each story, where P1 is the most critical.
  Think of each story as a standalone slice of functionality that can be:
  - Developed independently
  - Tested independently
  - Deployed independently
  - Demonstrated to users independently
-->

### User Story 1 - Invoke pie menu for quick actions (Priority: P1)

Как power-user Windows запускаю приложение и хочу мгновенно вызывать pie-меню горячей клавишей, чтобы выполнять часто используемые действия без переключения контекста.

**Why this priority**: Pie-меню — ядро ценности продукта; без стабильного вызова и исполнения действий инструмент бесполезен.

**Independent Test**: Можно полностью проверить, настроив глобальный хоткей, вызвав меню и запустив команду из предустановленного профиля; это демонстрирует основную ценность.

**Acceptance Scenarios**:

1. **Given** приложение работает в фоне и Pie-профиль активен, **When** пользователь нажимает глобальный хоткей, **Then** на активном мониторе отображается pie-меню в тёмной теме.
2. **Given** pie-меню открыто, **When** пользователь наводит курсор на сегмент и отпускает клавишу, **Then** соответствующее действие запускается (приложение, макрос или системная команда) и пользователь получает визуальное подтверждение.

---

### User Story 2 - Manage multiple automation profiles (Priority: P2)

Как пользователь с разными рабочими сценариями я хочу переключаться между профилями pie-меню и редактировать их в графическом редакторе, чтобы быстро адаптироваться к задачам.

**Why this priority**: Управление профилями обеспечивает гибкость и удержание пользователей; без него продукт не покрывает реальные сценарии.

**Independent Test**: Можно проверить, создав новый профиль, настроив сегменты и переключившись между профилями без перезапуска приложения.

**Acceptance Scenarios**:

1. **Given** открыт редактор профилей, **When** пользователь создаёт новый профиль и настраивает сегменты, **Then** изменения сохраняются в пользовательском хранилище и доступны сразу.
2. **Given** несколько профилей доступны, **When** пользователь активирует другой профиль из трея, **Then** глобальный хоткей начинает открывать pie-меню с настройками выбранного профиля.

---

### User Story 3 - Configure distribution and backup (Priority: P3)

Как аккуратный пользователь я хочу импортировать/экспортировать настройки и включить автозапуск при входе, чтобы быстро разворачивать одинаковую конфигурацию на разных машинах.

**Why this priority**: Позволяет облегчить распространение и восстановление, снижая барьер внедрения в команде.

**Independent Test**: Можно протестировать, экспортировав конфигурацию, установив приложение на другой системе, импортировав файл и проверив автозапуск.

**Acceptance Scenarios**:

1. **Given** активен профиль, **When** пользователь экспортирует конфигурацию в JSON, **Then** создаётся файл с профилями, действиями, иконками и настройками.
2. **Given** свежая установка приложения, **When** пользователь импортирует ранее сохранённый JSON, **Then** все профили и глобальные настройки восстанавливаются, и автозапуск остаётся включённым.
3. **Given** пользователь пытается импортировать повреждённый или неподписанный JSON, **When** валидатор обнаруживает ошибки схемы, **Then** процесс импортa прерывается, отображается список ошибок и предлагается восстановление из резервной копии.

### Edge Cases

- Что происходит, если глобальный хоткей конфликтует с уже зарегистрированным сочетанием? Приложение должно предложить альтернативу и показать предупреждение.
- Как система обрабатывает запуск действия, если целевое приложение или файл недоступны? Пользователь получает уведомление об ошибке и логирование.
- Как приложение ведёт себя при повреждённом или неподписанном JSON-файле импорта? Валидатор должен отклонить файл и показать список ошибок.
- Что делать, если pie-меню вызывается во время полноэкранной игры? Должен включаться безопасный режим отображения с минимальным оверхедом или уведомлением о невозможности запуска.
- Как обрабатывается отсутствие доступа к `%APPDATA%/AutoHotPie`? Приложение должно уведомить, предложить альтернативный путь и работать в режиме «только чтение» до решения проблемы.
- Какие риски несёт автоисполнение действий без подтверждений? Пользователь должен быть предупреждён в документации и при импорте профилей о доверии к источнику.
- Как отображаются логи в UI? Log Panel должен показывать текущий файл с автообновлением (каждые 5 сек), фильтрацией по уровню (INFO/WARN/ERROR/ACTION) и поиском по строке; при ошибке чтения отображается toast с рекомендацией открыть файл напрямую.
- Как пользователь узнаёт о read-only режиме и сбоях автозапуска? При невозможности записи в каталог данных или неудачах включения автозапуска отображается toast + баннер в Settings → Autostart с кнопкой повторить и ссылкой на quickstart troubleshooting.

## Requirements *(mandatory)*

<!--
  ACTION REQUIRED: The content in this section represents placeholders.
  Fill them out with the right functional requirements.
-->

### Functional Requirements

- **FR-001**: Система ДОЛЖНА предоставлять нативные Tauri-сборки для Windows, macOS и Linux с фоновым процессом и системным треем/меню.
- **FR-002**: Система ДОЛЖНА поддерживать регистрацию настраиваемых глобальных хоткеев на Windows, macOS и Linux с учётом платформенных особенностей (Win32 API, macOS Accessibility, X11/Wayland) и обеспечивать надёжный вызов pie-меню на активном дисплее.
- **FR-003**: Пользователь ДОЛЖЕН мочь создавать, дублировать, изменять и удалять профили pie-меню в визуальном редакторе.
- **FR-004**: Система ДОЛЖНА поддерживать структуру pie-меню с минимум 2 и максимум 12 сегментами на уровень при глубине вложенности до 3 уровней.
- **FR-005**: Пользователь ДОЛЖЕН мочь назначать действия сегментам: запуск приложений, отправка клавиатурных макросов, цепочки действий, системные команды.
- **FR-006**: Система ДОЛЖНА хранить пользовательские данные (профили, иконки, настройки) в каталоге данных пользователя: `%APPDATA%/AutoHotPie` (Windows), `~/Library/Application Support/AutoHotPie` (macOS), `~/.config/AutoHotPie` (Linux) с версионностью схемы.
- **FR-007**: Приложение ДОЛЖНО обеспечивать предпросмотр pie-меню в режиме редактора с отображением иконок, текстов и горячих клавиш.
- **FR-008**: Пользователь ДОЛЖЕН мочь импортировать и экспортировать конфигурации в формате JSON, совместимом между версиями (миграции схемы).
- **FR-009**: Система ДОЛЖНА предоставлять кроссплатформенный автозапуск профилей при входе пользователя и управление им через UI (включить/отключить). Реализации: Windows — Task Scheduler/Registry, macOS — LaunchAgents, Linux — systemd/xdg autostart с fallback-подсказками.
- **FR-010**: Система ДОЛЖНА предоставлять менеджер иконок: загрузка пользовательских иконок, выбор из встроенной библиотеки, оптимизация размера.
- **FR-011**: Интерфейс ДОЛЖЕН следовать тёмной теме и визуальному стилю, вдохновлённому `kando-2.0.0`: базовый фон `#111111`, основной акцент `#35B1FF`, типографика Inter/600 для заголовков и Inter/400 для текста, радиальные сегменты с анимацией увеличения 1.15× при наведении и 200 мс ease-in-out, а также композицию кругового меню с центральным ядром и внешними кольцами.
- **FR-012**: Система ДОЛЖНА предоставлять локализацию минимум на русском и английском, с возможностью переключения и загрузки переводов из JSON. Любая новая пользовательская функциональность и UI-тексты ДОЛЖНЫ сопровождаться локализационными ключами и переводами для всех поддерживаемых языков до завершения задачи.
- **FR-013**: Приложение ДОЛЖНО предоставлять историю и лог действий для отладки (запуски, ошибки, конфликты хоткеев) в UI. Log Panel обязан отображать текущий лог с автоподгрузкой последних записей, фильтрами по уровню, поиском, пермалинком «Open in Explorer» и fallback-сообщением при недоступности файла.
- **FR-014**: Backend ДОЛЖЕН реализовывать бизнес-логику через команды Tauri на Rust, инкапсулируя действия и доступ к файловой системе.
- **FR-015**: Система ДОЛЖНА обеспечивать уведомления и обратную связь (тосты, индикаторы состояния) при запуске действий, ошибках или автозапуске.
- **FR-016**: Пользователь ДОЛЖЕН мочь назначать разные хоткеи для каждого профиля и быстро переключать активный профиль из трея.
- **FR-017**: Система ДОЛЖНА проверять валидность макросов и предоставлять визуальный редактор/ввод с подсветкой ошибок перед сохранением, блокируя сохранение при критических ошибках и отображая подсказку для исправления. Валидация должна включать проверку синтаксиса, доступности ресурсов и совместимости с текущей платформой.
- **FR-018**: Приложение ДОЛЖНО работать офлайн и корректно обрабатывать отсутствие сетевого доступа.
- **FR-019**: Система ДОЛЖНА иметь механизм резервного копирования и восстановления пользовательских данных при обновлениях и автоматически хранить последние 5 резервных копий на профиль/набор настроек; при превышении лимита происходит FIFO-ротация с логированием операции.
- **FR-020**: Система ДОЛЖНА обнаруживать конфликты глобальных хоткеев и предлагать пользователю альтернативные сочетания либо временное отключение (UI показывает актуальные рекомендации и фиксирует событие в журнале действий).
- **FR-021**: Система ДОЛЖНА отслеживать состояние автозапуска на каждой платформе и синхронизировать его с UI: показывать текущее состояние (Enabled/Disabled/Unsupported/Errored), текст объяснения, кнопку Retry и ссылку на инструкции. В read-only режиме автозапуск должен блокироваться и сопровождаться баннером с указанием, как восстановить доступ к каталогу.
- **FR-022**: Система ДОЛЖНА предоставлять унифицированный UX при уважении платформенных паттернов (иконки меню, сочетания клавиш, жесты), включая адаптацию под macOS меню в строке меню и Linux tray environment fallback, с проверкой паритета поведения на целевых платформах.
- **FR-023**: Система ДОЛЖНА запускать действия сразу после выбора сегмента без дополнительных подтверждений, считая все пользовательские и импортированные действия доверенными.
- **FR-024**: Система ДОЛЖНА хранить локальные журналы действий и ошибок в файлах в каталоге данных пользователя и предоставлять кнопку "Log" в UI для открытия текущего файла логов.
- **FR-025**: Система ДОЛЖНА периодически проверять GitHub-релизы проекта (аналогично `kando-2.0.0`), уведомлять пользователя о доступности новой версии и предоставлять ссылку/кнопку для ручного скачивания установщика; автоматическая проверка выполняется каждые 6 часов во время работы приложения. Flow обновления должен корректно работать в оффлайн-режиме (кэш последнего успешного ответа + информативное сообщение без краша UI).
- **FR-026**: Система ДОЛЖНА поддерживать контекстные профили, активирующиеся только при совпадении условий по процессу/названию окна/области экрана активного приложения.

### Non-Functional Requirements

- **NFR-001**: Среднее время появления pie-меню после нажатия хоткея не превышает 50 мс на поддерживаемых платформах (измеряется на Windows 11, macOS 13 и Ubuntu 22.04 с эталонными профилями US1 и сценарием Playwright `tests/perf/latency.spec.ts`, фиксирующим 20 замеров hotkey → pie menu). Отчёт сохраняется в `tests/perf/reports/hotkey-latency.csv`.
- **NFR-002**: Время запуска действия (от выбора сегмента до подтверждения) не превышает 200 мс в 95-м перцентиле на тестовых профилях (измеряется тем же `tests/perf/latency.spec.ts`, шаг action → completion, 20 замеров на каждой платформе; результаты публикуются в `tests/perf/reports/action-latency.csv`).
- **NFR-003**: FPS в UI-оболочке не опускается ниже 60 кадров при активном предпросмотре и трёх открытых профилях (измеряется с помощью Playwright сценария `tests/perf/fps.spec.ts`, который запускает вход в редактор и снимает Chromium Performance trace). Аггрегированные значения (median FPS, p95 frame time) сохраняются в `tests/perf/reports/fps-metrics.csv` и PNG-графиках.
- **NFR-004**: Память процесса `autohotpie-tauri` не превышает 150 МБ при загрузке трёх профилей и журналов действий (замеры выполняет `tests/perf/latency.spec.ts`, собирая snapshot средствами OS APIs; отчёт `tests/perf/reports/memory-usage.csv` содержит медиану и p95).
- **NFR-006**: Поддерживаемые платформы (Windows 10/11, macOS 13+, Linux GTK/KDE) получают платформенно-специфичную интеграцию (трей, меню, автозапуск) при следующих измеримых критериях паритета UX (чеклист собирается в `specs/001-build-tauri-pie/quickstart.md`, тесты и ручные замеры документируются в `tests/e2e` и `tests/perf/reports`):
  1. **Функциональный охват**: Для каждого состояния автозапуска (Enabled, Disabled, Unsupported, Errored) доступны эквивалентные элементы UI (трей/меню/панель) и действия на всех трёх платформах; чеклист из 8 пунктов фиксируется в `quickstart.md`.
  2. **Визуальное соответствие**: Иконки и статусы трея/меню-бар повторяют одинаковые пиктограммы и цветовые состояния; скриншоты Windows/macOS/Linux сравниваются side-by-side и хранятся в `specs/001-build-tauri-pie/quickstart.md`.
  3. **Временные показатели**: Горячая клавиша → появление меню и переключение автозапуска выполняются не медленнее базовой платформы (Windows) более чем на 10% или 15 мс (берётся большее значение) по медиане 20 замеров.
  4. **Linux fallback**: При отсутствии системного трея появляется Linux fallback-панель с тем же набором действий и локализаций; Playwright-сценарий `linux-fallback.spec.ts` подтверждает сценарии "Toggle Autostart", "Switch Profile", "Open Logs".
  5. **Документированный результат**: Таблица со статусом проверки (pass/fail) и ссылками на доказательства (логи тестов, скриншоты) публикуется в `quickstart.md` до завершения задачи.

### Key Entities *(include if feature involves data)*

- **Profile**: `{ id: Uuid, name: string, isActive: bool, hotkey: HotkeyBinding, context: ContextRuleSet, rootMenuId: PieMenuId, version: u32 }`.
- **PieMenu**: `{ id: PieMenuId, title: string, appearance: PieAppearance, slices: PieSliceId[], maxDepth: u8 }`.
- **PieSlice**: `{ id: PieSliceId, label: string, icon: IconAssetId, action: ActionId, childMenuId?: PieMenuId, order: u8, hotkey?: HotkeyBinding }`.
- **Action**: `{ id: ActionId, kind: ActionKind, payload: ActionPayload, macroSteps?: MacroStep[], lastValidatedAt?: DateTime }`.
- **ContextRuleSet**: `{ id: ContextRuleSetId, priority: u8, rules: ContextRule[], defaultProfileId?: ProfileId }`.
  - **ContextRule**: `{ kind: 'process' | 'windowTitle' | 'region', pattern: string, matchType: 'equals' | 'contains' | 'regex', caseSensitive: bool }`.
  - Правила сортируются по `priority` (меньшее значение — выше приоритет). Совпадение любого правила в активном наборе активирует профиль; при коллизии выбирается профиль с наивысшим приоритетом.
**HotkeyBinding**: Определение глобального или локального сочетания клавиш с проверкой конфликтов.
**SettingsBundle**: Глобальные настройки приложения (тема, поведение трея, автозапуск, локализация).
**IconAsset**: Пользовательские и встроенные иконки (источник, путь, размер, лицензия).
**LocalizationPack**: Набор строк UI, сгруппированных по языку и области, с версией и статусом перевода.
**PreviewState**: Кэшированные расчёты для предпросмотра, включая позиционирование и анимации.

## UI/UX Specification

### Application Surfaces

- **Главное окно**: Рамка без системных кнопок, вдохновлённая `kando-2.0.0`, с панелью навигации слева (иконки разделов: Dashboard, Profiles, Actions, Settings) и контентной областью справа. Верхняя полоса содержит хлебные крошки, статус синхронизации и переключатель языка.
- **Панель быстрого доступа в трее**: Иконка приложения в системном трее с контекстным меню (активный профиль, быстрый запуск профилей, включение/выключение хоткеев, переход в настройки, выход).
- **Мастер первого запуска**: Пошаговые карточки по подбору горячих клавиш, выбору стартового профиля и объяснению структуры pie-меню.

### Pie Menu Visuals & Interaction

- **Форма меню**: Радиационный круг из 6 сегментов по умолчанию (настраиваемый диапазон 2–12), центр — «ядро» с названием профиля и подсказками. Дополнительные уровни отображаются концентрическими кольцами с хлебными крошками по окружности.
- **Темная тема**: Цветовая палитра в духе `kando-2.0.0` — фон #111, подсветка активного сегмента градиентом, неактивные сегменты полупрозрачные. Иконки и текст адаптивно инвертируются.
- **Наведение и выбор**: Сегмент увеличивается и подсвечивается при наведении мыши или указателя геймпада; центральная панель показывает описание действия, хоткей и кнопку предпросмотра. Выбор происходит при отпускании глобального хоткея или нажатием мыши.
- **Визуальные статусы**: Успешное выполнение действия сопровождается всплывающим тостом у центра экрана; ошибки — красной рамкой сегмента и уведомлением.
- **Расположение**: Меню автоматически появляется вблизи курсора, но не перекрывает системные панели; для мульти-мониторных установок открывается на активном мониторе.

### Profile Dashboard

- **Карточки профилей**: Сетка карточек с мини-превью радиального меню, индикатором активного статуса и кнопками быстрых действий (Activate, Edit, Duplicate, Export).
- **Фильтры**: Панель сверху позволяет сортировать по частоте использования, категории (работа, игры, монтаж), наличию нестандартных хоткеев.

### Profile Editor Layout

- **Структура экрана**: Левый столбец — дерево меню и сегментов в виде вложенного списка, центральная часть — интерактивный превью pie-меню, правый столбец — свойства выбранного сегмента.
- **Редактирование сегмента**: Поля «Название», «Описание», «Иконка», «Действие», «Хоткей», «Анимация», группа переключателей для поведения (задержка перед запуском, подтверждение, отображение подсказки).
- **Доступ к шаблонам**: В нижней части правого столбца галерея готовых сегментов из `AutoHotPiehttps-main` (например, «Window Management», «Text Snippets»), которые можно перетаскивать в меню.

### Action Builder & Macro Editor

- **Конструктор действий**: Табличное представление шагов (Launch app, Send keys, Delay, Run script), возможность перетаскивания и изменения порядка. Встроенный валидатор подсвечивает несовместимые шаги.
- **Запуск теста**: Кнопка «Test Action» в правом верхнем углу открывает всплывающий лог с результатом и временем выполнения.
- **Макро-ввод**: Окно записи горячих клавиш с визуализацией нажатий в реальном времени, возможность ручного редактирования в текстовом виде.

### Icon Manager & Preview

- **Библиотека иконок**: Категории (Системные, Работа, Игры, Медиа) с поиском и тегами. Превью адаптируется к темной теме и подсвечивает проблемные контрасты.
- **Загрузка пользовательских иконок**: Drag-and-drop с автоматическим преобразованием формата и оптимизацией до SVG/PNG 128×128.
- **Привязка к сегменту**: Выбор иконки непосредственно из панели свойств сегмента; окна предупреждения при удалении используемой иконки.

### Settings & Localization

- **Настройки**: Вкладки «General», «Hotkeys», «Storage», «Updates», «Accessibility». Для каждой вкладки используется двуколоночный layout настроек и описаний.
- **Локализация**: Переключатель языка в верхней панели, всплывающие подсказки показывают оригинальные и переведённые строки. Встроенный редактор позволяет просматривать JSON локализации и отмечать недостающие переводы.
- **Доступность**: Настройки масштабирования UI (90–150%), опция высококонтрастного режима, звуковые подсказки при открытии меню и выполнении действий.
- **Журнал**: Кнопка "Log" в заголовке окна повторяет стиль `kando-2.0.0` (иконка + подпись), открывает внешнюю панель просмотра логов с подсветкой уровней и кнопкой «Open File» для открытия исходного файла.

### Platform-Specific Considerations

- **Windows**: Интеграция с системным треем, поддержка high-DPI, переключатели Snap Layouts, использование Win32 API для хоткеев.
- **macOS**: Отображение иконки в статус-баре, поддержка жестов трекпада и команд ⌘, соблюдение правил sandbox (подпись и нотификации), использование Accessibility для захвата хоткеев.
- **Linux**: Поддержка desktop-окружений Gnome, KDE, Xfce с fallback UI при отсутствии системного трея; работа с X11 и Wayland через плагины Tauri, проверка наличия необходимых порталов.

### Assumptions & Constraints

- Приложение таргетирует Windows 10/11 (x64), macOS 13+ (Apple Silicon & Intel) и Linux (Ubuntu 22.04+, Fedora 38+, KDE Neon) с правами пользователя на установку автозапуска и регистрацию глобальных хоткеев.
- Максимальный размер импортируемого JSON — 5 МБ; большие файлы должны предупреждать пользователя.
- Глобальные хоткеи не должны перехватывать системные сочетания (Win+L, Ctrl+Alt+Del и т.п.).
- Пользователь имеет права на чтение/запись в соответствующем каталоге данных (`%APPDATA%`, `~/Library/Application Support`, `~/.config`); в корпоративной среде потребуется инструкция по выдаче доступа.
- Обновления приложения должны сохранять совместимость конфигураций из `AutoHotPiehttps-main` через миграции.
- Для Linux необходимо наличие поддерживаемого системного трея; при отсутствии — fallback в виде всплывающей панели.
- На macOS требуется разрешение Accessibility и Screen Recording для корректной работы хоткеев и предпросмотра.

## Success Criteria *(mandatory)*

<!--
  ACTION REQUIRED: Define measurable success criteria.
  These must be technology-agnostic and measurable.
-->

### Measurable Outcomes

- **SC-001**: 90% тестовых пользователей вызывают pie-меню и запускают действие менее чем за 2 секунды с момента нажатия хоткея.
- **SC-002**: Конфликты хоткеев выявляются и предотвращаются в 100% случаев в ходе тестирования на стандартном наборе приложений.
- **SC-003**: Импорт и экспорт JSON завершаются успешно и без потери данных в 5 из 5 тестов на реальных профилях из `AutoHotPiehttps-main`.
- **SC-004**: Не менее 80% бета-пользователей оценивают UX редактора профилей не ниже 4/5 по шкале удовлетворённости.
- **SC-005**: Приложение восстанавливает настройки после обновления без вмешательства пользователя в 100% тестовых сценариев.

